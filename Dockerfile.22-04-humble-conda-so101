FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive
ARG ROS_DISTRO=humble
ARG USER=user
ARG UID=1000

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

LABEL maintainer="sajib.pramanic@uef.fi"
LABEL org.opencontainers.image.source=https://github.com/SAJIB3489/docker-workstation.git
LABEL org.opencontainers.image.description="Ubuntu:22.04 , humble, Miniconda3, LeRobot Conda, SO-101 Workspace"
LABEL org.opencontainers.image.licenses=MIT

# Install base packages and basic utilities (including tzdata/locales non-interactive)
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg lsb-release build-essential git wget mesa-utils ssh gedit \
    locales tzdata procps file sudo python3-venv python3-pip python-is-python3 gpg \
    software-properties-common apt-transport-https \
  && rm -rf /var/lib/apt/lists/*

# Configure locale
RUN locale-gen en_US.UTF-8 \
  && update-locale LANG=en_US.UTF-8

# Create a non-root user and give passwordless sudo
RUN useradd -m -u ${UID} -s /bin/bash ${USER} \
  && echo "${USER} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${USER} \
  && chmod 0440 /etc/sudoers.d/${USER}

# Install Miniconda (multi-arch) into /home/${USER}/miniconda3
RUN set -eux; \
    arch="$(dpkg --print-architecture)"; \
    case "$arch" in \
      arm64|aarch64) installer=Miniconda3-latest-Linux-aarch64.sh ;; \
      amd64|x86_64) installer=Miniconda3-latest-Linux-x86_64.sh ;; \
      *) echo "Unsupported arch: $arch" >&2; exit 1 ;; \
    esac; \
    url="https://repo.anaconda.com/miniconda/${installer}"; \
    wget -q "$url" -O /tmp/miniconda.sh; \
    bash /tmp/miniconda.sh -b -u -p /home/${USER}/miniconda3; \
    rm -f /tmp/miniconda.sh; \
    chown -R ${UID}:${UID} /home/${USER}; \
    su - ${USER} -c "/home/${USER}/miniconda3/bin/conda init bash" || true

ENV PATH=/home/${USER}/miniconda3/bin:$PATH


# ROS 2 Humble
# Add ROS 2 apt repository
RUN set -eux; \
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg; \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" \
      | tee /etc/apt/sources.list.d/ros2.list > /dev/null

# Install ROS packages (desktop here; switch to ros-humble-ros-base for smaller image)
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
     ros-humble-ros-base ros-humble-rviz2 python3-rosdep python3-rosinstall-generator python3-vcstool doxygen libssh2-1-dev libudev-dev python3-colcon-common-extensions \
  && rm -rf /var/lib/apt/lists/*

# Initialize rosdep (safe to ignore errors)
RUN rosdep init || true \
  && rosdep update || true

RUN pip3 install -U catkin-tools \
    && pip3 install -U typeguard
    
##############SO-101 Workspace Setup##############
# 1. Python Environment

# Create an isolated Conda environment (non-interactive) and install LeRobot
RUN set -eux; \
    CONDA="/home/${USER}/miniconda3/bin/conda"; \
    # Accept Anaconda channel Terms of Service if conda enforces it (command varies by conda version).
    if "${CONDA}" tos --help >/dev/null 2>&1; then \
      su - ${USER} -c "${CONDA} tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main" || true; \
      su - ${USER} -c "${CONDA} tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r" || true; \
    fi; \
    su - ${USER} -c "cd /home/${USER} \
      && ${CONDA} create -y -n lerobot_ros2 --override-channels -c conda-forge python=3.10 pip \
      && ${CONDA} install -y -n lerobot_ros2 --override-channels -c conda-forge 'libstdcxx-ng>=12' 'libgcc-ng>=12' \
      && git clone https://github.com/nimiCurtis/lerobot.git \
      && cd lerobot \
      && ${CONDA} run -n lerobot_ros2 pip install -e '.[all]'"; \
    "${CONDA}" clean -afy

################################################

# Ensure conda directory is owned by the non-root user
RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> /home/${USER}/.bashrc 

# Make SSH available
EXPOSE 22

WORKDIR /home/${USER}
USER ${USER}

CMD ["bash"]